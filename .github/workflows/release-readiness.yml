name: Release Readiness Check

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional tag to validate (for dry runs)'
        required: false
        type: string
  schedule:
    # Run nightly to monitor drift
    - cron: '0 2 * * *'

concurrency:
  group: release-readiness-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  check-readiness:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Setup SSH for private repository access
        # Purpose: spec-kitty depends on private spec-kitty-events library.
        # Uses SSH deploy key stored in GitHub Actions secrets.
        # See docs/development/ssh-deploy-keys.md for setup instructions.
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SPEC_KITTY_EVENTS_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts
        shell: bash

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build tomli packaging pytest
          pip install -e .[test]

      - name: Verify test isolation
        run: |
          cat > verify_isolation.py << 'EOF'
          import sys
          import tomllib
          from pathlib import Path

          # Get source version from pyproject.toml
          with open("pyproject.toml", "rb") as f:
              source_version = tomllib.load(f)["project"]["version"]

          # Try to get installed version
          try:
              from importlib.metadata import version
              installed_version = version("spec-kitty-cli")
          except Exception:
              print(f"âœ… No installed version detected (source: {source_version})")
              sys.exit(0)

          # Check if versions match
          if installed_version == source_version:
              print(f"âœ… Version match: {source_version}")
              sys.exit(0)
          else:
              print(f"âŒ Version mismatch! Source: {source_version}, Installed: {installed_version}")
              print("Tests may fail due to version inconsistency.")
              sys.exit(1)
          EOF
          python verify_isolation.py

      - name: Run tests
        run: |
          echo "::group::Running test suite"
          python -m pytest -v
          echo "::endgroup::"

      - name: Validate release metadata
        id: validate
        continue-on-error: true
        run: |
          if [[ -n "${{ inputs.tag }}" ]]; then
            echo "Running validation in tag mode for dry run: ${{ inputs.tag }}"
            python scripts/release/validate_release.py --mode tag --tag "${{ inputs.tag }}"
          else
            echo "Running validation in branch mode"
            python scripts/release/validate_release.py --mode branch
          fi

      - name: Test packaging
        run: |
          echo "::group::Building wheel to catch packaging issues"
          python -m build --wheel
          echo "::endgroup::"

      - name: Generate readiness summary
        if: always()
        run: |
          echo "# Release Readiness Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.validate.outcome }}" == "success" ]]; then
            echo "âœ… **All readiness checks passed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This branch is ready for release:" >> $GITHUB_STEP_SUMMARY
            echo "- Version is properly bumped" >> $GITHUB_STEP_SUMMARY
            echo "- Changelog entry exists and is populated" >> $GITHUB_STEP_SUMMARY
            echo "- Version progression is monotonic" >> $GITHUB_STEP_SUMMARY
            echo "- Tests pass" >> $GITHUB_STEP_SUMMARY
            echo "- Package builds successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Readiness checks failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please complete the following before merging:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Required Actions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. **Version Bump** - Update version in \`pyproject.toml\`" >> $GITHUB_STEP_SUMMARY
            echo "2. **Changelog Entry** - Add release notes under \`## [X.Y.Z]\` in \`CHANGELOG.md\`" >> $GITHUB_STEP_SUMMARY
            echo "3. **Version Progression** - Ensure new version > latest tag" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See the validation output above for specific errors." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“– **Reference**: [Release Readiness Checklist](https://github.com/${{ github.repository }}/blob/main/docs/releases/readiness-checklist.md)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if validation failed
        if: steps.validate.outcome != 'success'
        run: |
          echo "::error::Release readiness checks failed. Review the validation output and job summary for details."
          exit 1
